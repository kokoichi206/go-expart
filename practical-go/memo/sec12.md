## ログとオブザーバビリティ

Hadoop や Spark などの分析に利用可能なシステムの登場。
→ 構造化ログ

オブザーバビリティを確保するには、クラウド運用コストの少なくとも 5~8% ほどが必要とういがいさんがある！

- デバッグの補助としてのログ
  - log パッケージ, testing.T の Log
- データ分析で必要な構造化ログ
  - zerolog, zap
- 分散トレーシング
  - go.opencensus.io, go.opentelemetry.io

## ログの目的

- 開発者目線
  - 不具合発生時の問題追跡
  - パフォーマンス改善ポイント発見のため
- 運用目線
  - サーバー停止などの確認
  - 監査
  - ユーザーの分析
- セキュリティ監査目線
  - ユーザーや管理者の操作を後から追跡できるようにする
  - 怪しげなリクエストの発見

セキュリティの場合はあ一定期間ログの保存が必要、また、ログが書き換えられないようにも気を配る。

## 出力項目

- エラー発生時は、エラーの発生箇所ごとにユニークな ID を発番して、それを出力すると良い！
  - フロント等に返すかは別として、エラーコードとして付与しておく。
- 起動直後の環境変数などのサーバー設定のダンプとか。
- ユーザー行動に影響のあるレコード・時間の経過とともに変化する状態！
  - ソシャゲ出の、ユーザーのレベル・所持金額等

## 出力頻度

内部の処理速度を計測する分散トレーシングも出力の頻度（サンプリングレート）を聖gほするパラメーターがある。

多くの場合、同一時間帯で負荷の高さが大体同じであれば、結果もおよそ似たようなものになることが期待される。
たまに発生するはずれ値の見落としもあるが、コストやパフォーマンスの問題もあり、適度にサンプリングレートを落として集計することが多い。

- エラーレベルや用途の重要度に応じて、ログの保存期間を変えたり
- ロギングサービスの保存期間は短めにして S3 や Cloud Storage などのコストの安いオブジェクトストレージにログを書き出して、必要な時に見れるようにする、っていう方法もある

**セキュリティに関するログ**

- サンプリングをせずに 100% 出力する必要がある
- [PCI DSS](https://docs-prv.pcisecuritystandards.org/PCI%20DSS/Supporting%20Document/PCI_DSS-QRG-v4_0.pdf) ではログに関するルールが決まっている！
  - 最低 3 ヶ月は即座にログの検査できるように
  - 最低 1 年はログを保存する
  - タイマーの同期
  - S3 には監査用の変更できないファイル保存のオプションがある！

## log package

`log.SetOutput` や `io.MultiWriter()` とか

## structured log

- zerolog
  - 高速！
- zap

### レベルの考え方

- debug: ロジックの途中経過
- info: アクセスログ
- warning: バリデーションエラーなどのリクエストがわのエラー
- error: サーバー内部で発生した、本来発生し得ないトラブル

## 分散システムのログ

単一のシステムと同じように状態が見られるようになっていることを「**オブザーバビリティがある**」と表現する。監視できてること！

テレメトリーと呼ばれる手法がある。OSS の OpenTelemetry など。

- 分散トレース
  - 複数のシステムにまたがっている処理を見える化！
- メトリクス
  - サービスの負荷や使用しているリソース量を把握！
- 構造化ログ
  - キーと値で複雑な情報も表現可能！

## OpenTelemetry

https://opentelemetry.io/

- アプリケーションと接続して計測 → Instrumentation
- 取り出した情報を送信 → Exporter

トレース ID を共有し、ライフラインに相当するのがスパン。

Go のライブラリでは Jaeger, Zipkin, などなど

https://opentelemetry.io/ecosystem/registry/





## Links

- [PSI](https://www.pcisecuritystandards.org/)
- [IPA: セキュリティログについて](https://www.ipa.go.jp/security/awareness/vendor/programmingv2/contents/c301.html)
