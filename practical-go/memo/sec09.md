## Database

アプリケーション > 汎用 API(database/sql) > データベースドライバ > データベース

データベースドライバをよくプランクインポートしている。プランクインポートで何が起こっているか → パッケージの init 関数が実行されている。

## sql.DB 構造体

- デフォルトでコネクションをプールする
- ゴルーチンセーフ
  - 多くの web アプリケーションハンドラーから同時に、かつ安全に使用可能！

## コネクションプールのパラメーターチューニング

- 同時にデータベースへ接続できるコネクション数
- アイドルのコネクションとしてコネクションを保持する最大の数
- コネクションを再利用できる最大時間
- コネクションがアイドル状態でいられる最大時間

## クエリのキャンセル

クエリーをキャンセルするにはコンテキストを使うのが一般的！

**db のドライバーがクエリーのキャンセルをサポートしている場合**、`context.WithCancel()` 等を利用してキャンセルするのがいい

## アプリケーションでクエリーをロギングする

lib/pq は持ってない、pgx ならいける。
https://future-architect.github.io/articles/20210916a/

sqlboiler などの ORM を使う場合は、それらば pgx などのドライバをサポートしてるかみる必要がある。

### sqlboiler

https://github.com/volatiletech/sqlboiler#debug-logging

``` go
import (
    "github.com/volatiletech/sqlboiler/v4/boil"
)

boil.DebugMode = true
```

## 共通からむは埋め込みで！

json などにエンコードしたときは問題なくフラットになっている！

## DB のテスト

### モックを使うケース

モックとして振る舞う挙動をテストコードとして記述するため、特にリファクタリングが大変！

シグニチャを変更した場合などはもれなくモック側の修正も必要になり、変更に対して何を担保しているのかがわかりにくくなる。

**できる限りローカルに起動した本物のデータベースをテストに用いることをお勧めする！**

## サードパーティのライブラリ

- スキーマドリブン
- クエリードリブン
