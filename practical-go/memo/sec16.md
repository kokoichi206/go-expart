## 並行

- goroutine
- channel
- select

## goroutine

- すでに利用可能なメモリがプロセス内にあれば OS からヒープメモリをもらうことなく、高速に起動できる
- メモリフットプリントもかなり小さい
- C10K 問題に対し、リクエストごとにゴルーチンを作成する
- 以下のことはできない
  - スレッドオブジェクトを通じて
    - スレッドの ID を取得
    - 優先度の設定
    - 終了したかどうかの確認
    - 終了をまったり
  - Java のバーチャルスレッド（将来実装されそう。。。）
- ローカル変数を定義したときにも、それが外部の関数に渡されたり、return で返されたりすると、
  - その変数が関数の寿命よりも長く存在するものとみなして、スタックではなくヒープにメモリを確保する！
  - スタック
    - 関数実行の履歴
    - 関数内部でのみ使われるデータを保持する
    - 高速なメモリ領域
    - コールスタックとも呼ばれる
  - ヒープ
    - 確保されたメモリは任意のタイミングで破棄される
    - 確保されたメモリ領域の寿命はサブルーチンの寿命に縛られない
    - 関数の内と外で共有されるメモリ（ポインター形式で関数の引数や返り値で外に渡るもの）

## チャネル

- 複数のゴルーチンから送受信しても安全が保証されているきゅー
  - 安全 = Exactly Once

## ゴルーチンセーフ

他の言語での**スレッドセーフと同じ意味**

``` sh
go test -race
```

## ゴルーチンループ

``` go
func Worker(tasks <-chan Task, results chan<- Result) {
    for t := range tasks {
        // DO SOMETHING

        // 結果の送信
        results <- Result {
            Value: v,
            Err: err,
        }
    }
}
```


## Tips

- 処理速度の制限
  - API の利用量などを制限する場合 → Rate Limit
    - go.uber.org/ratelimit
    - golang.org/x/time/rate
- 結果の受け取り
  - バッファ付きにするかどうかは、タスクの特性やボトルネックの場所によって変わる
- CPU と I/O という、競合していないリソースによってパフォーマンスが下がるという状態は改善すべき！
  - バッチ処理でも発生する
- default がある select はブロックしない
- Context
  - 1 セッションから派生するすべての処理をまとめてキャンセルする！
    - タイムアウトでの終了も含む
    - context.WithCancel
    - context.WithTimeout
    - context.WithDeadLine
  - 1 セッションの中で共有される情報を保持する
    - context.WithValue
- チャネルリークとは
- close
  - 同じチャネルを監視しているすべてのゴルーチンへ一斉に通知が届く
    - イベントのブロードキャスト
- 例外処理
  - いわゆるエラーを伝播していくエラー処理は、単一スレッドで複雑な処理を行なっている場合には機能する
- 完了までに時間のかかる関数の場合、第一引数 ctx としてコンテキストを渡すのが一般的！
- context の部分が新しい xxxContext, withContext に対応しているかどうか！
- ファンアウト・ファンイン
  - sync.WaitGroup
    - 単なるカウンター
  - errgroup.Group
    - タスクのスタート・終了の検知・カウンターの操作を隠蔽
- 業務アプリケーションの実装では go を自分で書くことはまれ！
- Future/Promise
  - お互いのタスクに依存関係がある時の、タスク分割の手法
- WithValue
  - Logger はコンテキストに入れるもの！
- ゴルーチンリーク
  - 次のどちらか
    - 中に for ループがあり、無限ループしている
    - チャネルの送受信によってブロックしている
  - ゴルーチンは GC の対象に入ってない！
- Go に限らず多くの言語では「リソースは確保した場所で開放処理が自動で呼ばれるようにする/開放処理を予約する」機構が用意されている！

